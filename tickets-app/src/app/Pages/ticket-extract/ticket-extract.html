<app-header></app-header>

<div class="content">
  <app-menu></app-menu>

  <div class="principal">
    
    <div class="upload-container">
      
      <h2 class="page-title">Subir Nuevo Ticket</h2>

      <div class="upload-card" *ngIf="!ticketResult && !isLoading">
        
        <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" style="display: none;">

        <div class="drop-area" (click)="fileInput.click()">
            <ng-container *ngIf="!imagePreview; else showPreview">
                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <p>Haz clic para seleccionar o arrastra tu ticket aquí</p>
                <span class="file-types">Soporta: JPG, PNG, WEBP</span>
            </ng-container>

            <ng-template #showPreview>
                <div class="preview-container">
                    <img [src]="imagePreview" alt="Previsualización" class="img-preview">
                    <p class="change-file-text">Haz clic para cambiar imagen</p>
                </div>
            </ng-template>
        </div>

        <button class="btn-primary" [disabled]="!selectedFile" (click)="uploadTicket()">
            Procesar con IA
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>

      <div class="loading-state" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>Analizando ticket con Inteligencia Artificial...</p>
      </div>

      <div class="results-card" *ngIf="ticketResult">
        <div class="results-header">
            <h3>Ticket Procesado</h3>
            <button class="btn-secondary" (click)="resetForm()">Subir otro</button>
        </div>

        <div class="results-grid">
            <div class="ticket-data">
                <div class="data-row">
                    <label>Empresa:</label>
                    <input type="text" [value]="ticketResult.company_name || 'No detectado'" 
                           [class.missing-data]="!ticketResult.company_name" readonly>
                </div>
                <div class="data-row">
                    <label>Total:</label>
                    <div class="input-with-symbol">
                        <input type="text" [value]="ticketResult.total || 'No detectado'" 
                           [class.missing-data]="!ticketResult.total" readonly class="highlight-input">
                        <span>€</span>
                    </div>
                </div>
                <div class="data-row">
                    <label>Fecha:</label>
                    <input type="text" [value]="ticketResult.date || 'No detectado'" 
                           [class.missing-data]="!ticketResult.date" readonly>
                </div>
                <div class="data-row">
                    <label>CIF:</label>
                    <input type="text" [value]="ticketResult.cif || 'No detectado'" 
                           [class.missing-data]="!ticketResult.cif" readonly>
                </div>
                <div class="data-row">
                    <label>Nº Factura:</label>
                    <input type="text" [value]="ticketResult.invoice_number || 'No detectado'" 
                           [class.missing-data]="!ticketResult.invoice_number" readonly>
                </div>
                <div class="data-row">
                    <label>Impuesto:</label>
                    <input type="text" [value]="ticketResult.igic || 'No detectado'" 
                           [class.missing-data]="!ticketResult.igic" readonly>
                </div>
                 <div class="data-row">
                    <label>Base Imponible:</label>
                    <input type="text" [value]="ticketResult.base_amount || 'No detectado'" 
                           [class.missing-data]="!ticketResult.base_amount" readonly>
                </div>
            </div>

            <div class="ticket-image-final">
                <p>Imagen Analizada:</p>
                <img [src]="ticketResult.image" alt="Ticket Procesado">
            </div>
        </div>
      </div>

    </div>
  </div>
</div>